{"ast":null,"code":"'use strict';\n\nvar EventEmitter = require('events').EventEmitter,\n  util = require('util'),\n  eachSeries = require('async/eachSeries'),\n  AsyncEventEmitter;\nmodule.exports = exports = AsyncEventEmitter = function AsyncEventEmitter() {\n  EventEmitter.call(this);\n};\nutil.inherits(AsyncEventEmitter, EventEmitter);\n\n/* Public methods\n============================================================================= */\n\nAsyncEventEmitter.prototype.emit = function (event, data, callback) {\n  var self = this,\n    listeners = self._events[event] || [];\n\n  // Optional data argument\n  if (!callback && typeof data === 'function') {\n    callback = data;\n    data = undefined;\n  }\n\n  // Special treatment of internal newListener and removeListener events\n  if (event === 'newListener' || event === 'removeListener') {\n    data = {\n      event: data,\n      fn: callback\n    };\n    callback = undefined;\n  }\n\n  // A single listener is just a function not an array...\n  listeners = Array.isArray(listeners) ? listeners : [listeners];\n  eachSeries(listeners.slice(), function (fn, next) {\n    var err;\n\n    // Support synchronous functions\n    if (fn.length < 2) {\n      try {\n        fn.call(self, data);\n      } catch (e) {\n        err = e;\n      }\n      return next(err);\n    }\n\n    // Async\n    fn.call(self, data, next);\n  }, callback);\n  return self;\n};\nAsyncEventEmitter.prototype.once = function (type, listener) {\n  var self = this,\n    _g2;\n  if (typeof listener !== 'function') {\n    throw new TypeError('listener must be a function');\n  }\n\n  // Hack to support set arity\n  if (listener.length >= 2) {\n    _g2 = function g(e, next) {\n      self.removeListener(type, _g2);\n      listener(e, next);\n    };\n  } else {\n    _g2 = function _g(e) {\n      self.removeListener(type, _g2);\n      listener(e);\n    };\n  }\n  _g2.listener = listener;\n  self.on(type, _g2);\n  return self;\n};\nAsyncEventEmitter.prototype.first = function (event, listener) {\n  var listeners = this._events[event] || [];\n\n  // Contract\n  if (typeof listener !== 'function') {\n    throw new TypeError('listener must be a function');\n  }\n\n  // Listeners are not always an array\n  if (!Array.isArray(listeners)) {\n    this._events[event] = listeners = [listeners];\n  }\n  listeners.unshift(listener);\n  return this;\n};\nAsyncEventEmitter.prototype.at = function (event, index, listener) {\n  var listeners = this._events[event] || [];\n\n  // Contract\n  if (typeof listener !== 'function') {\n    throw new TypeError('listener must be a function');\n  }\n  if (typeof index !== 'number' || index < 0) {\n    throw new TypeError('index must be a non-negative integer');\n  }\n\n  // Listeners are not always an array\n  if (!Array.isArray(listeners)) {\n    this._events[event] = listeners = [listeners];\n  }\n  listeners.splice(index, 0, listener);\n  return this;\n};\nAsyncEventEmitter.prototype.before = function (event, target, listener) {\n  return this._beforeOrAfter(event, target, listener);\n};\nAsyncEventEmitter.prototype.after = function (event, target, listener) {\n  return this._beforeOrAfter(event, target, listener, 'after');\n};\n\n/* Private methods\n============================================================================= */\n\nAsyncEventEmitter.prototype._beforeOrAfter = function (event, target, listener, beforeOrAfter) {\n  var listeners = this._events[event] || [],\n    i,\n    index,\n    add = beforeOrAfter === 'after' ? 1 : 0;\n\n  // Contract\n  if (typeof listener !== 'function') {\n    throw new TypeError('listener must be a function');\n  }\n  if (typeof target !== 'function') {\n    throw new TypeError('target must be a function');\n  }\n\n  // Listeners are not always an array\n  if (!Array.isArray(listeners)) {\n    this._events[event] = listeners = [listeners];\n  }\n  index = listeners.length;\n  for (i = listeners.length; i--;) {\n    if (listeners[i] === target) {\n      index = i + add;\n      break;\n    }\n  }\n  listeners.splice(index, 0, listener);\n  return this;\n};","map":null,"metadata":{},"sourceType":"script"}